<!DOCTYPE html>
<html data-ember-extension="1">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <link type="text/css" rel="stylesheet" href="../styles/bundle_style.css">
    <link type="text/css" rel="stylesheet" href="../styles/style.css">
    <link type="text/css" rel="stylesheet" href="../styles/jquery.nouislider.min.css">
    <link type="text/css" rel="stylesheet" href="../styles/jquery.nouislider.pips.min.css">

    <script src="../javascript/moment.min.js"></script>
    <script src="../javascript/numeral.min.js"></script>
    <script src="../javascript/jquery-1.11.1.min.js"></script>
    <script src="../javascript/jquery.nouislider.all.min.js"></script>
    <style type="text/css">

        path.arc {
            cursor: move;
            fill: #fff;
        }

        .node {
            font-size: 10px;
        }

        .node:hover {
            fill: #1f77b4;
        }

        .link {
            fill: none;
            stroke: #1f77b4;
            stroke-opacity: .4;
            pointer-events: none;
        }

        .link.source, .link.target {
            stroke-opacity: 1;
            stroke-width: 2px;
        }

        .node.target {
            fill: #d62728 !important;
        }

        .link.source {
            stroke: #d62728;
        }

        .node.source {
            fill: #2ca02c;
        }

        .link.target {
            stroke: #2ca02c;
        }

        .noUi-horizontal .noUi-handle {
            width: 20px;
        }


    </style>
</head>
<body>
<h1 style="position:absolute; right:0px;"><i>Routing Form</i><br/>Co-occurrence</h1>
<aside style="z-index: 200; top:40px;">
    <p>Filter: <select id="college">
    </select>

    <p>First Collaborations Between PIs Occurring from:<span id='latest_date'>Jan 1, 2011</span>
    </p>

    <p>
    <div id="slider"></div>

    </p>
    </p><p>This chord diagram visualizes co-occurrences in Routing Forms by PI.

</p>

    <p>Each link represents two investigators that appeared in the same routing form. Hover on investigator to highlight links.
        Diagram can be rotated. Colored arcs represent colleges.
        Red links are those where the selected investigator is not the primary. Green links are those where the selected investigator is the primary.
    </p>

    <p>Built with <a href="http://d3js.org/">d3.js</a>.
    </p>

    <p>
    <dl id="colors">
    </dl>
    </p>
</aside>

<script type="text/javascript" src="../javascript/d3.js"></script>
<script type="text/javascript" src="../javascript/d3.layout.js"></script>
<script type="text/javascript" src="packages.js"></script>
<script type="text/javascript">

var w = 1280,
        h = 800,
        rx = w / 2,
        ry = h / 2,
        m0,
        rotate = 0;

var splines = [];
var color = d3.scale.category20();
var scale = d3.scale.pow()
        .domain([0, 30000000])
        .range([2, 12]);

var cluster = d3.layout.cluster()
        .size([360, ry - 120])
        .sort(function (a, b) {
            return d3.ascending(a.key, b.key);
        });

var bundle = d3.layout.bundle();

var line = d3.svg.line.radial()
        .interpolate("bundle")
        .tension(.85)
        .radius(function (d) {
            return d.y;
        })
        .angle(function (d) {
            return d.x / 180 * Math.PI;
        });

// Chrome 15 bug: <http://code.google.com/p/chromium/issues/detail?id=98951>
var div = d3.select("body").insert("div", "h2")
        .style("top", "-80px")
        .style("left", "-160px")
        .style("width", w + "px")
        .style("height", w + "px")
        .style("position", "absolute")
        .style("-webkit-backface-visibility", "hidden");

var latest_link_dates = [
    new Date(2011, 6, 1),
    new Date(2012, 0, 1),
    new Date(2012, 6, 1),
    new Date(2013, 0, 1),
    new Date(2013, 6, 1),
    new Date(2014, 0, 1),
    new Date(2014, 6, 1),
    new Date(2015, 0, 1)
];
$("#slider").noUiSlider({
    start: [ 1, 3 ],
    behaviour: 'drag',
    connect: true,
    range: {
        'min':  0,
        'max':  7
    },
    step: 1,
    margin: 1
})
        .change(function() {
            tardis = false;
            show_date();
            jump();
        }
);

var first_link_dte = latest_link_dates[1];
var last_link_dte = latest_link_dates[2];

function show_date() {
    sliders = $('#slider').val();
    first_link_dte = latest_link_dates[Math.floor(sliders[0])];
    last_link_dte = latest_link_dates[Math.floor(sliders[1])];
    d3.select('#latest_date').text(moment(first_link_dte).format('M/D/YYYY') + " to " +moment(last_link_dte).format('M/D/YYYY') );
}
show_date();


function truncate_pi(pi) {
    rval = pi.split(',')[0] + ',';
    rval = rval + pi.split(',')[1][1];
    return rval;
}

function classify_pi(pi) {
    rval = pi.split(',')[0] + ',';
    rval = rval + pi.split(',')[1][1];
    return rval.replace(/[^a-zA-Z]/g, "_");
}

var svg;

var college_list = [],
        nodes = [],
        links = [],
        splines = [];
var all_people = [],
        all_links = [],
        filtered_links = [];

var college_selected = 'dentistry';
var college_name = 'Dentistry';

var mapped_colleges = [];

d3.json("only_all.json", function (all) {
    college_list = all.colleges;
    d3.select('#college')
            .selectAll('option')
            .data(college_list)
            .enter()
            .append('option')
            .attr("value", function (d) {
                return d.key;
            })
            .attr("selected", function (d) {
                return d.key == college_selected ? 'true' : null;
            })
            .text(function (d) {
                return d.college;
            });
    color = d3.scale.category20().domain(college_list.map(function (college) {
        return 'College: ' + college.college;
    }));
    map_colleges(college_list);
   setup(all.nodes, all.links);

});

function map_colleges(college_list) {
    var i = 0;
    college_list.forEach(function (d) {
        mapped_colleges[d.college] = i++;
        if (d.key != 'all') {
            d3.select("#colors")
                    .append("dt")
                    .text(d.college)
                    .append('dd')
                    .text('Investigators')
                    .style("background-color", color('College: ' + d.college));
        }
    });
}

function map_links(raw_links, nodes) {
    raw_links.forEach(function (link) {
        all_links.push({ source: all_people[link.source],
            target: all_people[link.target],
            value: link.value,
            earliest_collaboration: new Date(link.earliest_collaboration)});
    });
}

function setup(raw_people, raw_links) {
    all_people = raw_people;
    map_links(raw_links, all_people);
    nodes = all_people;
    links = all_links;
    jump();
    setTimeout(time_travel, 3000);
}

var tardis = true;
function time_travel() {
  var sliders = $('#slider').val();
  var first_slider = parseInt(sliders[0]);
  var last_slider = parseInt(sliders[1]);
  if (tardis && last_slider < 7)
  {
      first_slider = first_slider + 2;
      last_slider = last_slider + 2;
      $('#slider').val([first_slider, last_slider]);
      show_date();
      jump();
      setTimeout(time_travel, 3000);
  } else {
      tardis = false;
  }

}

function filter_links() {
    filtered_nodes = {};

    filtered_links = all_links.filter(function (d) {
        var match_college = d.source.pi_college == college_name;
        match_college = match_college || d.target.pi_college == college_name;
        match_college = match_college || college_selected == 'all';
        match_college = match_college || d.target.pi == college_name;
        match_college = match_college || d.source.pi == college_name;
        var is_match = d.earliest_collaboration <= last_link_dte && d.earliest_collaboration >= first_link_dte && (match_college);
        if (is_match) {
            filtered_nodes[d.target.rank] = d.target;
            filtered_nodes[d.source.rank] = d.source;
        }
        return is_match;
    });

    nodes = d3.values(filtered_nodes);
}

function jump() {

    filter_links();
    people = nodes;

    d3.select("svg").remove();
    if (!nodes[0] || !links[0]) return;
    nodes = cluster.nodes(packages.root(people));
    links = packages.map_linksv2(nodes, people, filtered_links);
    splines = bundle(links);

    svg = div.append("svg:svg")
            .attr("width", w)
            .attr("height", h)
            .append("svg:g")
            .attr("transform", "translate(" + rx + "," + ry + ")");

    svg.append("svg:path")
            .attr("class", "arc")
            .attr("d", d3.svg.arc().outerRadius(ry - 120).innerRadius(0).startAngle(0).endAngle(2 * Math.PI))
            .on("mousedown", mousedown);


    var matcher = new RegExp(college_selected, 'i');
    var path = svg.selectAll("path.link")
            .data(links)
            .enter().append("svg:path")
            .attr("class", function (d) {
                classes = "link source-" + classify_pi(d.source.key) + " target-" + classify_pi(d.target.key);
                return classes;
            })
            .attr("d", function (d, i) {
                return line(splines[i]);
            })
            .attr('stroke-width', function (d) {return scale(d.value);});

    var groupData = svg.selectAll("g.group")
                .data(nodes.filter(function(d) { return (d.key && d.key.match(/College:/) && d.children); }))
            .enter().append("group")
            .attr("class", "group");

    var groupArc = d3.svg.arc()
            .innerRadius(ry - 112)
            .outerRadius(ry - 122)
            .startAngle(function(d) {return (findStartAngle(d.__data__.children)-2) * Math.PI / 180;})
            .endAngle(function(d) {return (findEndAngle(d.__data__.children)+2) * Math.PI / 180;});

    var arc = svg.selectAll("g.arc")
            .data(groupData[0])
            .enter().append("svg:path")
            .attr("d", groupArc)
            .attr("class", "groupArc")
            .style("fill", function(d) {
                return color(d.__data__.key)
            })
            .style("fill-opacity", 0.8);



    svg.selectAll("g.node")
            .data(nodes.filter(function (n) {
                return !n.children;
            }))
            .enter().append("svg:g")
            .attr("class", function (d) {
                classes = "node";
                //classes = classes + (d.pi_college college_selected ? " active" : " inactive");
                return classes;
            })
            .attr("id", function (d) {
                return "node-" + classify_pi(d.key);
            })
            .attr("transform", function (d) {
                return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")";
            })
            .append("svg:text")
            .attr("dx", function (d) {
                return d.x < 180 ? 8 : -8;
            })
            .attr("dy", ".31em")
            .attr("text-anchor", function (d) {
                return d.x < 180 ? "start" : "end";
            })
            .attr("transform", function (d) {
                return d.x < 180 ? null : "rotate(180)";
            })
            .text(function (d) {
                return truncate_pi(d.key);
            })
            .on("mouseover", mouseover)
            .on("mouseout", mouseout);
}

d3.select("#college").on("change", function () {
    college_selected = this.value;
    college_name = this.selectedOptions.item().text;
    tardis = false;
    jump();
});



d3.select("input[type=range]").on("change", function () {
    latest_link = this.value;
    tardis = false;
    show_date();
    jump();
});

d3.select(window)
        .on("mousemove", mousemove)
        .on("mouseup", mouseup);

function mouse(e) {
    return [e.pageX - rx, e.pageY - ry];
}

function mousedown() {
    m0 = mouse(d3.event);
    d3.event.preventDefault();
}

function mousemove() {
    if (m0) {
        var m1 = mouse(d3.event),
                dm = Math.atan2(cross(m0, m1), dot(m0, m1)) * 180 / Math.PI;
        div.style("-webkit-transform", "translateY(" + (ry - rx) + "px)rotateZ(" + dm + "deg)translateY(" + (rx - ry) + "px)");
    }
}

function mouseup() {
    if (m0) {
        var m1 = mouse(d3.event),
                dm = Math.atan2(cross(m0, m1), dot(m0, m1)) * 180 / Math.PI;

        rotate += dm;
        if (rotate > 360) rotate -= 360;
        else if (rotate < 0) rotate += 360;
        m0 = null;

        div.style("-webkit-transform", null);

        svg
                .attr("transform", "translate(" + rx + "," + ry + ")rotate(" + rotate + ")")
                .selectAll("g.node text")
                .attr("dx", function (d) {
                    return (d.x + rotate) % 360 < 180 ? 8 : -8;
                })
                .attr("text-anchor", function (d) {
                    return (d.x + rotate) % 360 < 180 ? "start" : "end";
                })
                .attr("transform", function (d) {
                    return (d.x + rotate) % 360 < 180 ? null : "rotate(180)";
                });
    }
}

function fade(opacity) {
    svg.selectAll('g.node').style('opacity', opacity);
    svg.selectAll("path.link")
            .style('opacity', opacity)
            .each(fadeNode(opacity));
}

function fadeNode(opacity) {
    return function (d) {
        target_node = "#node-" + classify_pi(d.target.key);
        source_node = "#node-" + classify_pi(d.source.key);
        svg.select(source_node).style("opacity", opacity);
        svg.select(target_node).style("opacity", opacity);
    };
}

function mouseover(d) {
    fade(0.1);
    svg.select("#node-" + classify_pi(d.key)).style("opacity", 1);
    svg.selectAll("path.link.target-" + classify_pi(d.key))
            .style('opacity', 1)
            .classed("target", true)
            .each(updateNodes("source", true));

    svg.selectAll("path.link.source-" + classify_pi(d.key))
            .style('opacity', 1)
            .classed("source", true)
            .each(updateNodes("target", true));
}

function mouseout(d) {
    fade(1);
    svg.selectAll('g.node')
            .style('opacity', 1);
    svg.selectAll("path.link.source-" + classify_pi(d.key))
            .classed("source", false)
            .each(updateNodes("target", false));

    svg.selectAll("path.link.target-" + classify_pi(d.key))
            .classed("target", false)
            .each(updateNodes("source", false));
}

function updateNodes(name, value) {
    return function (d) {
        if (value) this.parentNode.appendChild(this);
        svg.select("#node-" + classify_pi(d[name].key)).classed(name, value).style('opacity', 1);
    };
}

function cross(a, b) {
    return a[0] * b[1] - a[1] * b[0];
}

function dot(a, b) {
    return a[0] * b[0] + a[1] * b[1];
}

function findStartAngle(children) {
    var min = children[0].x;
    children.forEach(function(d) {
        if (d.children){
            d.children.forEach(function (e) {
                if (e.x < min)
                    min = e.x;
            })
        } else {
            if (d.x < min)
                min = d.x;
        }
    });
    return min;
}

function findEndAngle(children) {
    var max = children[0].x;
    children.forEach(function(d) {
        if (d.children) {
            d.children.forEach(function (e) {
                if (e.x > max)
                    max = e.x;
            })
        } else {
            if (d.x > max)
                max = d.x;
        }
    });
    return max;
}

</script>

</body>
</html>
