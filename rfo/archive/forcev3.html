<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <link type="text/css" rel="stylesheet" href="../styles/style.css">
    <link type="text/css" rel="stylesheet" href="../styles/jquery.nouislider.min.css">
    <link type="text/css" rel="stylesheet" href="../styles/jquery.nouislider.pips.min.css">

    <script src="../javascript/moment.min.js"></script>
    <script src="../javascript/numeral.min.js"></script>
    <script src="../javascript/d3.v2.min.js"></script>
    <script src="../javascript/jquery-1.11.1.min.js"></script>
    <script src="../javascript/jquery.nouislider.all.min.js"></script>
    <script src="../javascript/d3.v2.min.js"></script>
    <script src="shared.js"></script>
    <style>

        .node {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        .link {
            stroke: #999;
            stroke-opacity: .6;
        }

        .noUi-horizontal .noUi-handle {
            width: 20px;
        }

    </style>
</head>
<body>
<h1><i>Routing Form</i> Co-occurrence</h1>
<aside style="margin-top:80px;">
    <p>Filter: <select id="college">
    </select>
    </p>

    <p>First Collaborations Between PIs Occurring from:<span id='latest_date'>Jan 1, 2011</span>
    </p>

    <p>

    <div id="slider"></div>
    <br/>
    Add and remove PIs when filtering: <input id='add_remove' name='add_remove' type="checkbox" checked>
    </p>


    <p>This force directed graph visualizes co-occurrences in Routing Forms by PI.

    </p>

    <p>Each colored dot represents a PI. Bolder links indicate the dollar value of the collaboration.
        Hover over dots to see more information about PIs.
        Hover over links to see the value of the collaboration)


    </p>

    <p>Built with <a href="http://d3js.org/">d3.js</a>.
    </p>

    <p>
    <dl id="colors">
    </dl>
    </p>
</aside>
<script>


    var width = 1080,
            height = 800;


    college_selected = 'engineering';
    college_name = "Engineering";


    set_dates_by_index('#slider', '#latest_date', 1, 3);

    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

    d3.json("data/only_all.json", function (all) {
        map_colleges(all.colleges, '#colors', '#college');
        setup(all.links, all.nodes);
    });

    var force = d3.layout.force()
            .charge(-10)
            .linkDistance(25)
            .size([width, height])
            .nodes(display_nodes)
            .links(display_links)
            .on("tick", tick);

    var link = svg.selectAll('.link'),
            node = svg.selectAll('.node');


    function setup(raw_links, raw_nodes) {
        all_nodes = type_nodes(raw_nodes);
        map_links(raw_links, all_nodes);
        render();
    }

    function draw_nodes() {
        node = node.data(force.nodes(), function (d) {
            return d.rank;
        });
        node.enter().append("circle")
                .attr("class", "node")
                .attr("r", 6)
                .style("fill", function (d) {
                    return college_colors(d.pi_college);
                })
                .call(force.drag);
        node.append("title")
                .text(function (d) {
                    return d.pi + " -- College: " + d.pi_college + ", Department: " + d.pi_department;
                });
        node.exit().remove();

    }

    function draw_links() {
        link = svg.selectAll('.link');
        link = link.data(force.links(), function (d) {
            return d.source.rank + "-" + d.target.rank;
        });
        link.enter().append("line")
                .attr("class", "link")
                .style("stroke-width", function (d) {
                    return link_width_scale(d.value);
                });
        link.append('title')
                .text(function (d) {
                    return numeral(d.value == 1 ? 0 : d.value).format('$0,0');
                });
        link.exit().remove();
    }

    function render() {

        filter_links(college_name, first_link_dte, last_link_dte, !d3.select('#add_remove').property('checked'), 0);

        force.charge(charge_scale(display_nodes.length));
        force.linkDistance(link_scale(display_nodes.length));
        force.nodes(display_nodes);
        force.links(display_links);
        draw_nodes();
        draw_links();
        force.start();
    }

    d3.select("input[type=checkbox]").on("change", function () {
        render();
    });


    function tick(e) {
        link.attr("x1", function (d) {
            var deltaX = d.target.x - d.source.x,
                    deltaY = d.target.y - d.source.y,
                    dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
                    normX = deltaX / dist,
                    normY = deltaY / dist,
                    sourcePadding = d.left ? 11 : 6,
                    targetPadding = d.right ? 11 : 6,
                    sourceX = d.source.x + (sourcePadding * normX),
                    sourceY = d.source.y + (sourcePadding * normY),
                    targetX = d.target.x - (targetPadding * normX),
                    targetY = d.target.y - (targetPadding * normY);
            return sourceX;
        })
                .attr("y1", function (d) {
                    var deltaX = d.target.x - d.source.x,
                            deltaY = d.target.y - d.source.y,
                            dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
                            normX = deltaX / dist,
                            normY = deltaY / dist,
                            sourcePadding = d.left ? 11 : 6,
                            targetPadding = d.right ? 11 : 6,
                            sourceX = d.source.x + (sourcePadding * normX),
                            sourceY = d.source.y + (sourcePadding * normY),
                            targetX = d.target.x - (targetPadding * normX),
                            targetY = d.target.y - (targetPadding * normY);
                    return sourceY;
                })
                .attr("x2", function (d) {
                    var deltaX = d.target.x - d.source.x,
                            deltaY = d.target.y - d.source.y,
                            dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
                            normX = deltaX / dist,
                            normY = deltaY / dist,
                            sourcePadding = d.left ? 11 : 6,
                            targetPadding = d.right ? 11 : 6,
                            sourceX = d.source.x + (sourcePadding * normX),
                            sourceY = d.source.y + (sourcePadding * normY),
                            targetX = d.target.x - (targetPadding * normX),
                            targetY = d.target.y - (targetPadding * normY);
                    return targetX;
                })
                .attr("y2", function (d) {
                    var deltaX = d.target.x - d.source.x,
                            deltaY = d.target.y - d.source.y,
                            dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
                            normX = deltaX / dist,
                            normY = deltaY / dist,
                            sourcePadding = d.left ? 11 : 6,
                            targetPadding = d.right ? 11 : 6,
                            sourceX = d.source.x + (sourcePadding * normX),
                            sourceY = d.source.y + (sourcePadding * normY),
                            targetX = d.target.x - (targetPadding * normX),
                            targetY = d.target.y - (targetPadding * normY);
                    return targetY;
                });

        node.attr("cx", function (d) {
            return d.x;
        })
                .attr("cy", function (d) {
                    return d.y;
                });
    }

</script>
</body>
</html>

