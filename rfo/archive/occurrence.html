<!DOCTYPE html>
<html class="ocks-org do-not-copy" data-ember-extension="1">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Researcher Co-occurrence on routing forms</title>
    <link type="text/css" rel="stylesheet" href="../styles/style.css">
    <style>


        .background {
            fill: #eee;
        }

        line {
            stroke: #fff;
        }

        text.active {
            fill: red;
        }

    </style>
    <script src="../javascript/d3.v2.min.js"></script>

</head>
<body>

<h1><i>Routing Form</i> Co-occurrence</h1>

<aside style="margin-top:80px;">
    <p>Filter: <select id="college">
    </select>

    <p>Order: <select id="order">
        <option value="name">by Name</option>
        <option value="count">by Frequency</option>
        <option value="college">by College</option>
        <option value="department">by Department</option>
    </select>

    </p>
    <p>This matrix diagram visualizes co-occurrences in Routing Forms by PI.

    </p>

    <p>Each colored cell represents two PIs that appeared in the same routing form; darker cells indicate PIs that
        co-occurred more frequently.

    </p>

    <p>Use the drop-down menu to reorder the matrix and explore the data.

    </p>

    <p>Built with <a href="http://d3js.org/">d3.js</a>.
    </p>
    <p>
    <dl id="colors">
    </dl>
    </p>
</aside>

<script>

    var college_selected = 'business';

    var margin = {top: 80, right: 0, bottom: 10, left: 80},
            width = 1020,
            height = 1020;

    var x = d3.scale.ordinal().rangeBands([0, width]),
            z = d3.scale.linear().domain([0, 4]).clamp(true);
    var mapped_colleges = [];
    var colleges_mapped = false;

    function map_colleges(college_list) {
        if (!colleges_mapped) {
            colleges_mapped = true;
            var i = 0;
            college_list.forEach(function (d) {
                mapped_colleges[d.college] = i++;
                if (d.key != 'all') {
                    d3.select("#colors")
                            .append("dt")
                            .text(d.college)
                            .append('dd')
                            .text('Nodes')
                            .style("background-color", color(d.college));
                }
            });
        }
    }

    function jump() {
        d3.select("svg").remove();
        var svg = d3.select("body").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .style("margin-left", -margin.left + "px")
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        d3.json("occurrence.json", function (miserables) {
            var college_list = miserables.colleges;
            color = d3.scale.category20().domain(college_list.map(function (college) {
                return college.college
            }));

            map_colleges(college_list);
            d3.select('#college')
                    .selectAll('option')
                    .data(college_list)
                    .enter()
                    .append('option')
                    .attr("value", function (d) {
                        return d.key;
                    })
                    .attr("selected", function (d) {
                        return d.key == college_selected ? 'true' : null;
                    })
                    .text(function (d) {
                        return d.college;
                    });

            var college_data;
            college_data = miserables[college_selected];
            var matrix = [],
                    nodes = college_data.nodes,
                    n = nodes.length;

            // Compute index per node.
            nodes.forEach(function (node, i) {
                node.index = i;
                node.count = 0;
                matrix[i] = d3.range(n).map(function (j) {
                    return {x: j, y: i, z: 0};
                });
            });

            // Convert links to matrix; count character occurrences.
            college_data.links.forEach(function (link) {
                matrix[link.source][link.target].z += link.value;
                matrix[link.target][link.source].z += link.value;
                matrix[link.source][link.source].z += link.value;
                matrix[link.target][link.target].z += link.value;
                nodes[link.source].count += link.value;
                nodes[link.target].count += link.value;
            });

            // Precompute the orders.
            var orders = {
                name: d3.range(n).sort(function (a, b) {
                    return d3.ascending(nodes[a].pi, nodes[b].pi);
                }),
                count: d3.range(n).sort(function (a, b) {
                    return nodes[b].count - nodes[a].count;
                }),
                college: d3.range(n).sort(function (a, b) {
                    return d3.ascending(nodes[b].pi_college, nodes[a].pi_college);
                }),
                department: d3.range(n).sort(function (a, b) {
                    return d3.ascending(nodes[b].pi_department, nodes[a].pi_department);
                })
            };

            // The default sort order.
            x.domain(orders.name);

            svg.append("rect")
                    .attr("class", "background")
                    .attr("width", width)
                    .attr("height", height);

            var row = svg.selectAll(".row")
                    .data(matrix)
                    .enter().append("g")
                    .attr("class", "row")
                    .attr("transform", function (d, i) {
                        return "translate(0," + x(i) + ")";
                    })
                    .each(row);

            row.append("line")
                    .attr("x2", width);

            row.append("rect")
                    .attr("x", -10)
                    .attr('class','name_rect')
                    .attr("y", (x.rangeBand() / 2) - 5)
                    .style("fill", function(d,i) {return color(nodes[i].pi_college);})
                    .attr('height', 10)
                    .attr("width", 10);

            row.append("text")
                    .attr("x", -12)
                    .attr("y", x.rangeBand() / 2)
                    .attr("dy", ".32em")
                    .attr("text-anchor", "end")
                    .attr('background-color', function(d,i) { })
                    .text(function (d, i) {
                        return truncate_pi(nodes[i].pi);
                    });

            var column = svg.selectAll(".column")
                    .data(matrix)
                    .enter().append("g")
                    .attr("class", "column")
                    .attr("transform", function (d, i) {
                        return "translate(" + x(i) + ")rotate(-90)";
                    });

            column.append("line")
                    .attr("x1", -width);
            column.append("rect")
                    .attr("x", 2)
                    .attr('class','name_rect')
                    .attr("y", (x.rangeBand() / 2) - 5)
                    .style("fill", function(d,i) {return color(nodes[i].pi_college);})
                    .attr('height', 10)
                    .attr("width", 10);

            column.append("text")
                    .attr("x", 12)
                    .attr("y", x.rangeBand() / 2)
                    .attr("dy", ".32em")
                    .attr("text-anchor", "start")
                    .text(function (d, i) {
                        return truncate_pi(nodes[i].pi);
                    });

            function row(row) {
                var cell = d3.select(this).selectAll(".cell")
                        .data(row.filter(function (d) {
                            return d.z;
                        }))
                        .enter().append("rect")
                        .attr("class", "cell")
                        .attr("x", function (d) {
                            return x(d.x);
                        })
                        .attr("width", x.rangeBand())
                        .attr("height", x.rangeBand())
                        .style("fill-opacity", function (d) {
                            return z(d.z);
                        })
                        .style("fill", function (d) {
                            return nodes[d.x].pi_college == nodes[d.y].pi_college ? color(nodes[d.x].pi_college) : null;
                        })
                        .on("mouseover", mouseover)
                        .on("mouseout", mouseout)
                        .append("title")
                        .text(function (d) {
                            return create_title(d)
                        });
                ;
            }

            function create_title(d) {
                title = nodes[d.x].pi + " -- College: " + nodes[d.x].pi_college + ", Department: " + nodes[d.x].pi_department;
                title = title + " \n " + nodes[d.y].pi + " -- College: " + nodes[d.y].pi_college + ", Department: " + nodes[d.y].pi_department;
                return title;
            }

            function mouseover(p) {
                d3.selectAll(".row text").classed("active", function (d, i) {
                    return i == p.y;
                });
                d3.selectAll(".column text").classed("active", function (d, i) {
                    return i == p.x;
                });
            }

            function mouseout() {
                d3.selectAll("text").classed("active", false);
            }

            d3.select("#order").on("change", function () {
                order(this.value);
            });

            function order(value) {
                x.domain(orders[value]);

                var t = svg.transition().duration(2500);

                t.selectAll(".row")
                        .delay(function (d, i) {
                            return x(i) * 4;
                        })
                        .attr("transform", function (d, i) {
                            return "translate(0," + x(i) + ")";
                        })
                        .selectAll(".cell")
                        .delay(function (d) {
                            return x(d.x) * 4;
                        })
                        .attr("x", function (d) {
                            return x(d.x);
                        });

                t.selectAll(".column")
                        .delay(function (d, i) {
                            return x(i) * 4;
                        })
                        .attr("transform", function (d, i) {
                            return "translate(" + x(i) + ")rotate(-90)";
                        });
            }

            function truncate_pi(pi) {
                rval = pi.split(',')[0] + ',';
                rval = rval + pi.split(',')[1][1];
                return rval;
            }

        });
    }

    jump();

    d3.select("#college").on("change", function () {
        college_selected = this.value;
        d3.select('#order').selectAll('option').each(function (d, i) {
            this.selected = this.value == 'name' ? 'true' : null;
        })
        jump();
    });

</script>


<script type="text/javascript" src="chrome-extension://bmdblncegkenkacieihfhpjfppoconhi/in-page-script.js"></script>
</body>
</html>
