<!DOCTYPE html>
<html class="ocks-org do-not-copy" data-ember-extension="1">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Researcher Co-occurrence on routing forms</title>
    <link type="text/css" rel="stylesheet" href="../styles/style.css">
    <link type="text/css" rel="stylesheet" href="../styles/jquery.nouislider.min.css">
    <link type="text/css" rel="stylesheet" href="../styles/jquery.nouislider.pips.min.css">
    <style>


        .background {
            fill: #eee;
        }

        line {
            stroke: #fff;
        }

        text.active {
            fill: red;
        }

        .noUi-horizontal .noUi-handle {
            width: 20px;
        }
    </style>
    <script src="../javascript/d3.v2.min.js"></script>
    <script src="../javascript/moment.min.js"></script>
    <script src="../javascript/numeral.min.js"></script>
    <script src="../javascript/jquery-1.11.1.min.js"></script>
    <script src="../javascript/jquery.nouislider.all.min.js"></script>

</head>
<body>

<h1><i>Routing Form</i> Co-occurrence</h1>

<aside style="margin-top:80px;">
    <p>Filter: <select id="college">
    </select>

    <p>Order: <select id="order">
        <option value="name">by Name</option>
        <option value="count">by Frequency</option>
        <option value="college">by College</option>
        <option value="department">by Department</option>
    </select>

    </p>
    <p>First Collaborations Between PIs Occurring from:<span id='latest_date' style="font-weight: bold"></span>
    </p>

    <p>

    <div id="slider"></div><br/>
    <p>This matrix diagram visualizes co-occurrences in Routing Forms by PI.

    </p>

    <p>Each colored cell represents two PIs that appeared in the same routing form; darker cells indicate PIs that
        co-occurred more frequently.

    </p>

    <p>Use the drop-down menu to reorder the matrix and explore the data.

    </p>

    <p>Built with <a href="http://d3js.org/">d3.js</a>.
    </p>

    <p>
    <dl id="colors">
    </dl>
    </p>
</aside>

<script>

var college_selected = 'engineering';
var college_name = "Engineering";
var all_links = [];
var all_nodes = [];
var display_links = [];
var display_nodes = [];
var mapped_links = [];
var selected_order = 'name';

var margin = {top: 80, right: 0, bottom: 10, left: 80},
        width = 1020,
        height = 1020;

var x = d3.scale.ordinal().rangeBands([0, width]);
var mapped_colleges = [];
var colleges_mapped = false;

var latest_link_dates = [
    new Date(2011, 6, 1),
    new Date(2012, 0, 1),
    new Date(2012, 6, 1),
    new Date(2013, 0, 1),
    new Date(2013, 6, 1),
    new Date(2014, 0, 1),
    new Date(2014, 6, 1),
    new Date(2015, 0, 1)
];


var first_link_dte = latest_link_dates[1];
var last_link_dte = latest_link_dates[3];

function show_date() {
    sliders = $('#slider').val();
    first_link_dte = latest_link_dates[Math.floor(sliders[0])];
    last_link_dte = latest_link_dates[Math.floor(sliders[1])];
    d3.select('#latest_date').text(moment(first_link_dte).format('M/D/YYYY') + " to " +moment(last_link_dte).format('M/D/YYYY') );
}


$("#slider").noUiSlider({
    start: [ 1, 3 ],
    behaviour: 'drag',
    connect: true,
    range: {
        'min':  0,
        'max':  7
    },
    step: 1,
    margin: 1
})
        .change(function() {
//            d3.select('#order').selectAll('option').each(function (d, i) {
//                this.selected = this.value == 'name' ? 'true' : null;
//            });
            show_date();
            jump();
        }
);

show_date();

function map_colleges(college_list) {
    if (!colleges_mapped) {
        colleges_mapped = true;
        var i = 0;
        college_list.forEach(function (d) {
            mapped_colleges[d.college] = i++;
            if (d.key != 'all') {
                d3.select("#colors")
                        .append("dt")
                        .text(d.college)
                        .append('dd')
                        .text('Investigators')
                        .style("background-color", color(d.college));
            }
        });
    }
}

var color = d3.scale.category20();
var opacity_scale = d3.scale.linear().domain([1000000, 30000000]).range([.5,1]).clamp(true);

d3.json("only_all.json", function (all) {
    var college_list = all.colleges;
    color = d3.scale.category20().domain(college_list.map(function (college) {
        return college.college
    }));

    map_colleges(college_list);
    d3.select('#college')
            .selectAll('option')
            .data(college_list)
            .enter()
            .append('option')
            .attr("value", function (d) {
                return d.key;
            })
            .attr("selected", function (d) {
                return d.key == college_selected ? 'true' : null;
            })
            .text(function (d) {
                return d.college;
            });

    setup(all.nodes, all.links);

});


function setup(raw_nodes, raw_links) {
    all_links = raw_links;
    all_nodes = raw_nodes;
    map_links(all_links, all_nodes);
    jump();
}


function map_links(raw_links, nodes) {
    raw_links.forEach(function (link) {
        mapped_links.push({ source: nodes[link.source],
            target: nodes[link.target],
            value: link.value,
            earliest_collaboration: new Date(link.earliest_collaboration)})
    });
}

function filter_links(earliest_date, latest_date) {
    filtered_nodes = {};

    display_links = mapped_links.filter(function (d) {
        var match_college = d.source.pi_college == college_name;
        match_college = match_college || d.target.pi_college == college_name;
        match_college = match_college || college_selected == 'all';
        match_college = match_college || d.target.pi == college_name;
        match_college = match_college || d.source.pi == college_name;
        var is_match = d.earliest_collaboration >= earliest_date && d.earliest_collaboration <= latest_date && (match_college);
        if (is_match) {
            filtered_nodes[d.target.rank] = d.target;
            filtered_nodes[d.source.rank] = d.source;
        }
        return is_match;
    });

    //if (d3.select('#add_remove').property('checked')) {
        display_nodes = d3.values(filtered_nodes);
//    } else {
//        display_nodes = all_nodes;
//    }

}


function jump() {
    filter_links(first_link_dte, last_link_dte);
    d3.select("svg").remove();
    var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .style("margin-left", -margin.left + "px")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    var matrix = [],
            nodes = display_nodes,
            n = nodes.length;

    // Compute index per node.
    nodes.forEach(function (node, i) {
        node.index = i;
        node.count = 0;
        matrix[i] = d3.range(n).map(function (j) {
            return {x: j, y: i, z: 0};
        });
    });

    // Convert links to matrix; count character occurrences.
     display_links.forEach(function (link) {
        matrix[link.source.index][link.target.index].z += link.value;
        matrix[link.target.index][link.source.index].z += link.value;
        matrix[link.source.index][link.source.index].z += link.value;
        matrix[link.target.index][link.target.index].z += link.value;
        nodes[link.source.index].count += link.value;
        nodes[link.target.index].count += link.value;
    });

    // Precompute the orders.
    var orders = {
        name: d3.range(n).sort(function (a, b) {
            return d3.ascending(nodes[a].pi, nodes[b].pi);
        }),
        count: d3.range(n).sort(function (a, b) {
            return nodes[b].count - nodes[a].count;
        }),
        college: d3.range(n).sort(function (a, b) {
            return d3.ascending(nodes[b].pi_college, nodes[a].pi_college);
        }),
        department: d3.range(n).sort(function (a, b) {
            return d3.ascending(nodes[b].pi_department, nodes[a].pi_department);
        })
    };

    // The default sort order.
    x.domain(orders[selected_order]);

    svg.append("rect")
            .attr("class", "background")
            .attr("width", width)
            .attr("height", height);

    var row = svg.selectAll(".row")
            .data(matrix)
            .enter().append("g")
            .attr("class", "row")
            .attr("transform", function (d, i) {
                return "translate(0," + x(i) + ")";
            })
            .each(row);

    row.append("line")
            .attr("x2", width);

    row.append("rect")
            .attr("x", -10)
            .attr('class', 'name_rect')
            .attr("y", (x.rangeBand() / 2) - 5)
            .style("fill", function (d, i) {
                return color(nodes[i].pi_college);
            })
            .attr('height', 10)
            .attr("width", 10);

    row.append("text")
            .attr("x", -12)
            .attr("y", x.rangeBand() / 2)
            .attr("dy", ".32em")
            .attr("text-anchor", "end")
            .attr('background-color', function (d, i) {
            })
            .text(function (d, i) {
                return truncate_pi(nodes[i].pi);
            });

    var column = svg.selectAll(".column")
            .data(matrix)
            .enter().append("g")
            .attr("class", "column")
            .attr("transform", function (d, i) {
                return "translate(" + x(i) + ")rotate(-90)";
            });

    column.append("line")
            .attr("x1", -width);
    column.append("rect")
            .attr("x", 2)
            .attr('class', 'name_rect')
            .attr("y", (x.rangeBand() / 2) - 5)
            .style("fill", function (d, i) {
                return color(nodes[i].pi_college);
            })
            .attr('height', 10)
            .attr("width", 10);

    column.append("text")
            .attr("x", 12)
            .attr("y", x.rangeBand() / 2)
            .attr("dy", ".32em")
            .attr("text-anchor", "start")
            .text(function (d, i) {
                return truncate_pi(nodes[i].pi);
            });

    function row(row) {
        var cell = d3.select(this).selectAll(".cell")
                .data(row.filter(function (d) {
                    return d.z;
                }))
                .enter().append("rect")
                .attr("class", "cell")
                .attr("x", function (d) {
                    return x(d.x);
                })
                .attr("width", x.rangeBand())
                .attr("height", x.rangeBand())
                .style("fill-opacity", function (d) {
                    return opacity_scale(d.z);
                })
                .style("fill", function (d) {
                    return nodes[d.x].pi_college == nodes[d.y].pi_college ? color(nodes[d.x].pi_college) : null;
                })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout)
                .append("title")
                .text(function (d) {
                    return create_title(d)
                });
        ;
    }

    function create_title(d) {
        title = nodes[d.x].pi + " -- College: " + nodes[d.x].pi_college + ", Department: " + nodes[d.x].pi_department;
        title = title + " \n AND " + nodes[d.y].pi + " -- College: " + nodes[d.y].pi_college + ", Department: " + nodes[d.y].pi_department;
        title = title + " \n Award Totals: " + numeral(d.z == 1 ? 0 : d.z).format('$0,0');
        return title;
    }

    function mouseover(p) {
        d3.selectAll(".row text").classed("active", function (d, i) {
            return i == p.y;
        });
        d3.selectAll(".column text").classed("active", function (d, i) {
            return i == p.x;
        });
    }

    function mouseout() {
        d3.selectAll("text").classed("active", false);
    }

    d3.select("#order").on("change", function () {
        selected_order = this.value;
        order(this.value);
    });

    function order(value) {
        x.domain(orders[value]);

        var t = svg.transition().duration(2500);

        t.selectAll(".row")
                .delay(function (d, i) {
                    return x(i) * 4;
                })
                .attr("transform", function (d, i) {
                    return "translate(0," + x(i) + ")";
                })
                .selectAll(".cell")
                .delay(function (d) {
                    return x(d.x) * 4;
                })
                .attr("x", function (d) {
                    return x(d.x);
                });

        t.selectAll(".column")
                .delay(function (d, i) {
                    return x(i) * 4;
                })
                .attr("transform", function (d, i) {
                    return "translate(" + x(i) + ")rotate(-90)";
                });
    }

    function truncate_pi(pi) {
        rval = pi.split(',')[0] + ',';
        rval = rval + pi.split(',')[1][1];
        return rval;
    }

}

//d3.select("input[type=checkbox]").on("change", function () {
//    d3.select('#order').selectAll('option').each(function (d, i) {
//        this.selected = this.value == 'name' ? 'true' : null;
//    })
//    jump();
//});

d3.select("#college").on("change", function () {
    college_selected = this.value;
    college_name = this.selectedOptions.item().text
//    d3.select('#order').selectAll('option').each(function (d, i) {
//        this.selected = this.value == 'name' ? 'true' : null;
//    })
    jump();
});

</script>


<script type="text/javascript" src="chrome-extension://bmdblncegkenkacieihfhpjfppoconhi/in-page-script.js"></script>
</body>
</html>
