<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- bower:css -->
    <link rel="stylesheet" href="bower_components/nouislider/distribute/jquery.nouislider.min.css" />
    <link rel="stylesheet" href="bower_components/nouislider/distribute/jquery.nouislider.pips.min.css" />
    <link rel="stylesheet" href="bower_components/qtip2/jquery.qtip.css" />
    <link rel="stylesheet" href="bower_components/bootstrap/docs/assets/css/bootstrap.css" />
    <link rel="stylesheet" href="bower_components/bootstrap-css/css/bootstrap.min.css" />
    <!-- endbower -->

    <!-- bower:js -->
    <script src="bower_components/modernizr/modernizr.js"></script>
    <script src="bower_components/jquery/jquery.js"></script>
    <script src="bower_components/underscore/underscore.js"></script>
    <script src="bower_components/jquery-ui/jquery-ui.js"></script>
    <script src="bower_components/moment/moment.js"></script>
    <script src="bower_components/numeral/numeral.js"></script>
    <script src="bower_components/nouislider/distribute/jquery.nouislider.all.min.js"></script>
    <script src="bower_components/ericmmartin.simplemodal/src/jquery.simplemodal.js"></script>
    <script src="bower_components/eventEmitter/EventEmitter.js"></script>
    <script src="bower_components/eventie/eventie.js"></script>
    <script src="bower_components/imagesloaded/imagesloaded.js"></script>
    <script src="bower_components/qtip2/jquery.qtip.js"></script>
    <script src="bower_components/bootstrap/docs/assets/js/bootstrap.js"></script>
    <script src="bower_components/d3/d3.js"></script>
    <script src="bower_components/dimple/dist/dimple.v2.1.6.min.js"></script>
    <script src="bower_components/bootstrap-css/js/bootstrap.min.js"></script>
    <!-- endbower -->

    <link type="text/css" rel="stylesheet" href="styles/jquery-ui.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jquery-ui.structure.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jquery-ui.theme.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jquery.nouislider.pips.min.css">
    <link type="text/css" rel="stylesheet" href="styles/style.css">

    <script src="javascript/sharedv2.js"></script>
    <style>

        .node {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        .link {
            stroke: #999;
            stroke-opacity: .6;
        }

    </style>
</head>
<body>
<h1>Researcher Productivity</h1>
<aside style="margin-top:80px;">

    <div id="filters">
        <label for="autofilter">Filter</label>
        <input id="autofilter">

        <div id="selected_filters">
        </div>
    </div>

    <p>
        Based on data from:<span id='latest_date'>Jan 1, 2011</span>
    </p>
    <p>
    <div id="slider" class="noUi-extended ui-helper-hidden"></div>
    <br/>
    <p class="ui-helper-hidden">
    Add and remove PIs when filtering: <input id='add_remove' name='add_remove' type="checkbox" checked>
    </p>
    <div>
        <label class="label-right"><input type="radio" name="value_by" value="pi_count" checked>Proposals as PI</label>
        <label class="label-right"><input type="radio" name="value_by" value="adirect">Award Dollars</label>
        <label class="label-right"><input type="radio" name="value_by" value="all_counts">All Proposals (PI, CO-I, Technician)</label>
    </div>
    <p>
        This force directed graph visualizes Researcher Productivity based on propsals and awards.
    </p>

    <p>
        Each colored dot represents a PI.
        Hover over dots to see more information.  The table below lists up to the top 100 Researchers based on current selections.
    </p>

    <p>
        Built with <a href="http://d3js.org/">d3.js</a>.
    </p>

    <p>
    <dl id="colors">
    </dl>
    </p>
</aside>
<div id="svg_content">

</div>
<div id="table_content">

</div>
<script>


    var width = 1080,
            height = 800;

    center = {x: width / 2, y: height / 2};

    // TODO: 1) change to use object notation i.e.  var config = { color_by: "pi_college", value_by: "value"....
    // TODO: 3) change to use new file "combined_..."
    // TODO: 3.1)        college is now org
    //                   value is now rf_award_value
    //                   pi_department is now department
    //                   rank is user_id
    // TODO: 4) change filters so they are an array i.e.  filters: [ { name: "college", field: "Org", prefix: "College: "}, { name: "department", ...
    // TODO: 4.1)    need to change other methods to use filters appropriately
    // TODO: 5) do the same for bundle, occurrence html files.  combine into a single javascript file if appropriate.

    var config = {
        source: "data/combined_occurrence_and_similarity.json",
        color_by: "Org",
        value_by: "pi_count",
        node_id: "user_id",
        filters:[
          {
            name: "primary",
            prefix: "College: ",
            selected: ['College of Engineering'],
            button_class: "primary_button",
            field: "Org"
          },
          {
            name: "secondary",
            prefix: "Department: ",
            selected: [],
            button_class: "selected_button",
            field: "department"
          }
        ],

        //primary_filters_selected = ['College of Engineering'];
        //secondary_filters_selected = [];
        //primary_filter: "Org",
        //primary_filter_prefix: 'College: ',
        //secondary_filter: "department",
        //secondary_filter_prefix: 'Department: '

        primary_filter_input: $('#autofilter'),
        selected_filters_container: $('#selected_filters'),
        date_fields: ["earliest_occurrence"],
        node_tip_attribute: 'data-title',
        link_tip_attribute: 'data-title',
        node_tip_html: node_tip_content,
        node_tip_method: node_tips,
        filter_date_field: "earliest_occurrence"
    };


    function node_tip_content(d) {
        var content = [];
        content.push("Investigator: <span class='bold'>" + d.display_name_reverse + "</span>");
        content.push("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + "College: <span class='bold'>" + d.Org + "</span>");
        content.push("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + "Department: <span class='bold'>" + d.department + "</span>");
        content.push("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + "Proposals as PI: <span class='bold'>" + numeral(d.pi_count).format('0,0') + "</span>");
        content.push("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + "Proposals as Co-Investigator: <span class='bold'>" + numeral(d.coi_count).format('0,0') + "</span>");
        content.push("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + "Proposals as Technician: <span class='bold'>" + numeral(d.tech_count).format('0,0') + "</span>");
        content.push("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + "Award $: <span class='bold'>" + numeral(d.adirect).format('$0,0') + "</span>");
        return encodeURI(content.join("<br />"));
    }

    function node_tips() {
        set_tips('.node', config.node_tip_attribute);
    }

    function set_tips(selector, content_attribute) {
        $(selector).each(function () {
            $(this).qtip({
                content: {
                    text: decodeURI($(this).attr(content_attribute))
                },
                position: {
                    my: 'top center',
                    at: 'bottom center'
                }, style: {
                    classes: 'qtip-light node-tip',
                    tip: {
                        corner: true,
                        height: 24
                    }
                },
                hide: {
                    fixed: true,
                    delay: 100
                }
            });
        });
    }


    set_dates_by_index('#slider', '#latest_date', 0, 7);

    var svg = d3.select("#svg_content").append("svg")
            .attr("width", width)
            .attr("height", height);

    var clusters = {},
            padding = 2, // separation between same-color nodes
            clusterPadding = 6;  // separation between different-color nodes

    //TODO:  2) move file name to configuration

    function setup_value_by(nodes) {
        all_values = nodes.map(function (node) {
            return node[config.value_by];
        });

        all_values = all_values.sort(function (a, b) {
            return a - b
        });

        set_domains_by_value(all_values[0], all_values[all_values.length - 1]);
        set_domains_by_count(all_values.length);
    }

    d3.json(config.source, function (all) {
        all_primary_filter_values = d3.set(all.nodes.map(function (node) {
            return node[find_filter("primary").field];
        })).values().sort();
        all_primary_filter_values.unshift("All");
        all_primary_filter_values.obj = get_obj("primary");

        all_secondary_filter_values = d3.set(all.nodes.map(function (node) {
            return node[find_filter("secondary").field];
        })).values().sort();
        all_secondary_filter_values.unshift("All");
        all_secondary_filter_values.obj = get_obj("secondary");

        set_selected_colors(
          d3.set(
            all.nodes.map(function (node) {
              return node[find_filter("primary").field];
            })
          ).values().sort()
        , '#colors');
        map_filters([all_primary_filter_values, all_secondary_filter_values]);
        setup_value_by(all.nodes);
        setup(all.links, all.nodes);
    });

    var force = d3.layout.force()
            .charge(-10)
            .size([width, height])
            .nodes(display_nodes)
            .on("tick", tick);

    var node = svg.selectAll('.node');


    function setup(raw_links, raw_nodes) {
        all_nodes = type_nodes(raw_nodes);
        map_links(raw_links, all_nodes);
        render();
    }

    function draw_nodes() {
        node = node.data(force.nodes(), function (d) {
            return d[config.node_id];
        });
        node.enter().append("circle")
                .attr("class", function (d) {
                    return "node node_" + d[config.node_id]
                })
                .attr("r", function (d) {
                    d.radius = node_size_scale(d[config.value_by]);
                    return node_size_scale(d[config.value_by]);
                })
                .style("fill", function (d) {
                    return primary_colors(d[config.color_by]);
                })
                .attr(config.node_tip_attribute, config.node_tip_html)
                .call(force.drag);
        node.exit().remove();


        clusters = {};
        node.each(function (d) {
            if (!clusters[d[find_filter("primary").field]] || (d[config.value_by] > clusters[d[find_filter("primary").field]][config.value_by])){
              clusters[d[find_filter("primary").field]] = d;
            }
        });

        config.node_tip_method();

    }

    function draw_table() {
        $table_div = $('#table_content');
        $table_div.empty();
        $table = $table_div.append("<table class='table table-striped' style='width: "+ width +"px'><caption>This table lists the top 100 Investigators or fewer based on current selections.</caption><thead><tr><td>Investigator</td><td>Org</td><td>Department</td><td>Proposals<br/>as PI</td><td>Proposals<br/>as CO-I</td><td>Proposals<br/>as Tech</td><td>Award $</td></tr><thead><tbody></tbody></table>");
        $table_body = $table.find('tbody');
        tr_template = "<tr><td>{display_name_reverse}</td><td>{Org}</td><td>{department}</td><td class='number'>{pi_count}</td><td class='number'>{coi_count}</td><td class='number'>{tech_count}</td><td class='number'>{adirect}</td></tr>";

        table_count = 0;
        display_nodes.sort(function(a,b) {
            return b[config.value_by] - a[config.value_by];
        }).some(function(d) {
            this_tr = tr_template;
            ['display_name_reverse','Org','department','pi_count','coi_count','tech_count'].map(function (element, index) {
                replace_key = "{" + element + "}";
                this_tr = this_tr.replace(replace_key, d[element] );
            });
            this_tr = this_tr.replace("{adirect}", numeral(d.adirect).format('$0,0'))
            $table_body.append($(this_tr));
            table_count += 1;
            return table_count > 100;
        });

    }

    function render() {

        filter_links(find_filter("primary").selected, first_link_dte, last_link_dte, !d3.select('#add_remove').property('checked'), 0, find_filter("secondary").selected, true);

        d3.layout.pack()
                .sort(null)
                .size([width, height])
                .children(function(d) { return d.values; })
                .value(function(d) {
                    return node_size_scale(d[config.value_by]);
                })
                .nodes({values: d3.nest()
                        .key(function(d) { return d[config.value_by]; })
                        .entries(d3.selectAll('.node'))});

        force.charge(function(d){ return -Math.pow(d.radius, 2.0) / 4;});
        force.nodes(display_nodes);
        draw_nodes();
        draw_table();
        force.start();
    }

    $("input[type=checkbox], input[type=radio]").on("change", function () {
        old_value_by = config.value_by
        new_value_by = $("[name='value_by']:checked").val();
        if (old_value_by != new_value_by) {
            config.value_by = new_value_by;
            setup_value_by(all_nodes);
            d3.selectAll('.node')
                    .attr('r',function(d) { return node_size_scale(d[config.value_by]); })
                    .attr(config.node_tip_attribute, config.node_tip_html);
        }
        render();
    });


    function tick(e) {
        node
                .attr("cx", function (d) {
                    radius_factor = ( d.radius * e.alpha * 20);
                    return d.x = Math.max(15 + radius_factor , Math.min(width - (15 + radius_factor), d.x));
                })
                .attr("cy", function (d) {
                    radius_factor = ( d.radius * e.alpha * 20);
                    return d.y = Math.max(15 + radius_factor, Math.min(height - (15 + radius_factor), d.y));
                })
                .each(cluster(10 * e.alpha * e.alpha))
                .each(collide(.3))
        ;

    }
    var move_toward_center = true;

    function cluster(alpha) {
        return function(d) {
            var cluster = clusters[d[find_filter("primary").field]];
            if (cluster === d) {
                if (move_toward_center) {
                    d.x = d.x + (center.x - d.x) * (0.02) * alpha;
                    d.y = d.y + (center.y - d.y) * (0.02) * alpha;
                }
                return;
            }
            var x = d.x - cluster.x,
                    y = d.y - cluster.y,
                    l = Math.sqrt(x * x + y * y),
                    r = d.radius + cluster.radius;
            if (l != r) {
                l = (l - r) / l * alpha;
                d.x -=  x *= l;
                d.y -= y *= l;
            }
        };
    }

    // Resolves collisions between d and all other circles.
    function collide(alpha) {
        var quadtree = d3.geom.quadtree(d3.selectAll('.node'));
        return function(d) {
            var r = d.radius + node_size_scale.range()[1], // + Math.max(padding, clusterPadding),
                    nx1 = d.x - r,
                    nx2 = d.x + r,
                    ny1 = d.y - r,
                    ny2 = d.y + r;
            quadtree.visit(function(quad, x1, y1, x2, y2) {
                if (quad.point && (quad.point !== d)) {
                    var x = d.x - quad.point.x,
                            y = d.y - quad.point.y,
                            l = Math.sqrt(x * x + y * y),
                            r = d.radius + quad.point.radius + (d[find_filter("primary").field] === quad.point[find_filter("primary").field] ? padding : clusterPadding);
                    if (l < r) {
                        l = (l - r) / l * alpha;
                        var primary_cluster_node = clusters[d[find_filter("primary").field]];
                        if (primary_cluster_node != d) {
                            d.x -= x *= l;
                            d.y -= y *= l;
                        }
                        if (primary_cluster_node != quad.point) {
                            quad.point.x += x;
                            quad.point.y += y;
                        }
                    }
                }
                return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
            });
        };
    }

</script>
</body>
</html>

