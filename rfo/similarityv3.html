<!DOCTYPE html>
<html class="ocks-org do-not-copy" data-ember-extension="1">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Researcher Similarity Based on Award Titles</title>

    <!-- bower:js -->
    <script src="bower_components/modernizr/modernizr.js"></script>
    <script src="bower_components/jquery/jquery.js"></script>
    <script src="bower_components/underscore/underscore.js"></script>
    <script src="bower_components/jquery-ui/jquery-ui.js"></script>
    <script src="bower_components/moment/moment.js"></script>
    <script src="bower_components/numeral/numeral.js"></script>
    <script src="bower_components/nouislider/distribute/jquery.nouislider.all.min.js"></script>
    <script src="bower_components/ericmmartin.simplemodal/src/jquery.simplemodal.js"></script>
    <script src="bower_components/eventEmitter/EventEmitter.js"></script>
    <script src="bower_components/eventie/eventie.js"></script>
    <script src="bower_components/imagesloaded/imagesloaded.js"></script>
    <script src="bower_components/qtip2/jquery.qtip.js"></script>
    <script src="bower_components/bootstrap/docs/assets/js/bootstrap.js"></script>
    <script src="bower_components/d3/d3.js"></script>
    <script src="bower_components/dimple/dist/dimple.v2.1.6.min.js"></script>
    <script src="bower_components/bootstrap-css/js/bootstrap.min.js"></script>
    <!-- endbower -->

    <script src="javascript/sharedv2.js"></script>

    <!-- bower:css -->
    <link rel="stylesheet" href="bower_components/nouislider/distribute/jquery.nouislider.min.css" />
    <link rel="stylesheet" href="bower_components/nouislider/distribute/jquery.nouislider.pips.min.css" />
    <link rel="stylesheet" href="bower_components/qtip2/jquery.qtip.css" />
    <link rel="stylesheet" href="bower_components/bootstrap/docs/assets/css/bootstrap.css" />
    <link rel="stylesheet" href="bower_components/bootstrap-css/css/bootstrap.min.css" />
    <!-- endbower -->

    <link type="text/css" rel="stylesheet" href="styles/style.css">
    <link type="text/css" rel="stylesheet" href="styles/jquery-ui.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jquery-ui.structure.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jquery-ui.theme.min.css">
    <style>


        .background {
            fill: #eee;
        }

        line {
            stroke: #fff;
        }

        text.active {
            fill: red;
        }

        .noUi-horizontal .noUi-handle {
            width: 20px;
        }
    </style>

</head>
<body>

<h1>Award Title Similarity</h1>

<aside style="margin-top:80px;">
    <div id="filters">
        <label for="autofilter">Filter</label>
        <input id="autofilter">
        <div id="selected_filters">
        </div>
    </div>


    <p>Order: <select id="order">
        <option value="name">by Name</option>
        <option value="count">by Count of Similar Individuals</option>
        <option value="college">by College</option>
    </select>

    </p>
    Similarity Measure: <span id='similarity' style="font-weight: bold"></span>

    <div id="slider"></div>

    <p>This matrix diagram visualizes Similarity of PIs based on Award Titles and project summaries for the months of
        June, July, and August 2014.
        Similarity is determined using a <a href="http://en.wikipedia.org/wiki/Vector_space_model">Vector Space Model
            (VSM)</a>
        with <a href="http://en.wikipedia.org/wiki/Tf%E2%80%93idf">tf*idf weights</a>.
        Additional data would improve the accuracy of this model.
    </p>

    <p>Each colored cell represents two PIs that similar to each other based on award titles; darker cells indicate PIs
        that
        more similar.
    </p>

    <p>Use the slider to change the threshold of similarity for Investigators displayed. Click on
        the cells to see the Investigator's names and the terms used to determine similarity.</p>

    <p>Built with <a href="http://d3js.org/">d3.js</a>.
    </p>

    <dl id="colors">
    </dl>
</aside>

<script>


var margin = {top: 80, right: 0, bottom: 10, left: 80},
        width = 1020,
        height = 1020;

var width_rangeBand = d3.scale.ordinal().rangeBands([0, width]);
var similarity_limit = 0.3;
var selected_order = 'name';


var config = {
  color_by: "pi_college",
  value_by: "value",
  significance_value_by: 'value',
  node_id: "contact_pi",
//  primary_filter: "college",
//  primary_filter_prefix: 'College: ',
//  primary_filters_selected = ['All'];
//  secondary_filters_selected = [];

  filters:[
    {
      name: "primary",
      prefix: "College: ",
      selected: ['All'],
      button_class: "primary_button",
      field: "college"
    },
    { // TODO: secondary filter only included here
      // because we must have one to make things work with the current state of
      // filter_links function
      name: "secondary",
      prefix: "Department: ",
      selected: [],
      button_class: "selected_button",
      field: "pi_department"
    }
  ],

  date_fields: ["earliest_collaboration"],
  filter_date_field: "earliest_collaboration",
  node_tip_attribute: 'data-title',
  link_tip_attribute: 'data-title',
  node_tip_html: node_tip_content,
  link_tip_html: link_tip_content,
  link_tip_method: link_tips,
  selected_filters_container: $('#selected_filters'),
  primary_filter_input: $('#autofilter'),
  node_label: 'contact_pi'
};

function node_tip_content(d) {
    var content = [];
    content.push("Investigator: <span class='bold'>" + d.contact_pi + "</span>");
    content.push("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + "College: <span class='bold'>" + d.college + "</span>");
    return encodeURI(content.join("<br />"));
}

function link_tips() {
    set_tips('.cell', config.link_tip_attribute);
}

function link_tip_content(d) {
    source_content = config.node_tip_html(display_nodes[d.x]);
    target_content = d.x == d.y ? "" : config.node_tip_html(display_nodes[d.y]);

    var content = [];
    content.push("<br/><br/>Similarity: " + numeral(d.z).format('0[.]0000'));
    content.push("(Click cell for more information.)");
    return source_content + encodeURI("<br/><br/>") + target_content + encodeURI(content.join("<br />"));
}

function set_tips(selector, content_attribute) {
    $(selector).each(function () {
        $(this).qtip({
            content: {
                text: decodeURI($(this).attr(content_attribute))
            },
            position: {
                my: 'top center',
                at: 'bottom center'
            }, style: {
                classes: 'qtip-light node-tip',
                tip: {
                    corner: true,
                    height: 24
                }
            },
            hide: {
                fixed: true,
                delay: 100
            }
        });
    });
}

$("#slider").noUiSlider({
    start: 0.3,
    range: {
        'min':  0.0,
        'max':  0.9
    },
    step: 0.1
})
        .change(function() {
            similarity_limit = $('#slider').val();
            show_similarity();
            render();
        }
);

function show_similarity() {
    $('#similarity').text(similarity_limit);
}

show_similarity();

d3.json("data/pi_similarity.json", function (all) {
    all_primary_filter_values = d3.set(
      all.nodes.map(function (node) {
        return node[find_filter("primary").field];
      })
    ).values().sort();
    all_primary_filter_values.unshift("All");
    all_primary_filter_values.obj = get_obj('primary');
    all_secondary_filter_values = [];
    all_secondary_filter_values.obj = get_obj("secondary");

    set_selected_colors(
      d3.set(
        all.nodes.map(function (node) {
          return node[find_filter("primary").field];
        })
      ).values().sort()
    , '#colors');
    map_filters([all_primary_filter_values, all_secondary_filter_values]);
    all_values = all.links.map(function (node) { return parseInt(node[config.value_by]); });
    all_values = all_values.sort(function(a, b){return a-b});
    set_domains_by_value(all_values[0], all_values[all_values.length - 1]);
    setup(all.links, all.nodes);
});


function setup(raw_links, raw_nodes) {
    map_links(raw_links, raw_nodes);
    render();
}

function render() {
    filter_links(find_filter("primary").selected, first_link_dte, last_link_dte, false, similarity_limit, find_filter("secondary").selected);

    d3.select("svg").remove();
    var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .style("margin-left", -margin.left + "px")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    var matrix = [],
            nodes = display_nodes,
            n = nodes.length;

    // Compute index per node.
    nodes.forEach(function (node, i) {
        node.index = i;
        node.count = 0;
        matrix[i] = d3.range(n).map(function (j) {
            return {x: j, y: i, z: 0};
        });
    });

    // Convert links to matrix; count character occurrences.
    display_links.forEach(function (link) {
        matrix[link.source.index][link.target.index].z = link[config.value_by];
        matrix[link.target.index][link.source.index].z = link[config.value_by];
        if (link.source.index != link.target.index) {
            matrix[link.source.index][link.source.index].z += 1;
            matrix[link.target.index][link.target.index].z += 1;
        }
        nodes[link.source.index].count += 1;
        nodes[link.target.index].count += 1;
    });

    // Precompute the orders.
    var orders = {
        name: d3.range(n).sort(function (a, b) {
            return d3.ascending(nodes[a][config.node_label], nodes[b][config.node_label]);
        }),
        count: d3.range(n).sort(function (a, b) {
            return nodes[b].count - nodes[a].count;
        }),
        college: d3.range(n).sort(function (a, b) {
            return d3.ascending(nodes[b][find_filter("primary").field], nodes[a][find_filter("primary").field]);
        })
    };

    // The default sort order.
    width_rangeBand.domain(orders[selected_order]);

    svg.append("rect")
            .attr("class", "background")
            .attr("width", width)
            .attr("height", height);

    var row = svg.selectAll(".row")
            .data(matrix)
            .enter().append("g")
            .attr("class", "row")
            .attr("transform", function (d, i) {
                return "translate(0," + width_rangeBand(i) + ")";
            })
            .each(row);


    config.link_tip_method();

    row.append("line")
            .attr("x2", width);

    row.append("rect")
            .attr("x", -10)
            .attr('class', 'name_rect')
            .attr("y", (width_rangeBand.rangeBand() / 2) - 5)
            .style("fill", function (d, i) {
                return primary_colors(nodes[i][find_filter("primary").field]);
            })
            .attr('height', 10)
            .attr("width", 10);

    row.append("text")
            .attr("x", -12)
            .attr("y", width_rangeBand.rangeBand() / 2)
            .attr("dy", ".32em")
            .attr("text-anchor", "end")
            .attr('background-color', function (d, i) {
            })
            .text(function (d, i) {
                return truncate_pi(nodes[i][config.node_label]);
            });

    var column = svg.selectAll(".column")
            .data(matrix)
            .enter().append("g")
            .attr("class", "column")
            .attr("transform", function (d, i) {
                return "translate(" + width_rangeBand(i) + ")rotate(-90)";
            });

    column.append("line")
            .attr("x1", -width);
    column.append("rect")
            .attr("x", 2)
            .attr('class', 'name_rect')
            .attr("y", (width_rangeBand.rangeBand() / 2) - 5)
            .style("fill", function (d, i) {
                return primary_colors(nodes[i][find_filter("primary").field]);
            })
            .attr('height', 10)
            .attr("width", 10);

    column.append("text")
            .attr("x", 12)
            .attr("y", width_rangeBand.rangeBand() / 2)
            .attr("dy", ".32em")
            .attr("text-anchor", "start")
            .text(function (d, i) {
                return truncate_pi(nodes[i][config.node_label]);
            });

    function row(row) {
        var cell = d3.select(this).selectAll(".cell")
                .data(row.filter(function (d) {
                    return d.z;
                }))
                .enter().append("rect")
                .attr("class", "cell")
                .attr("x", function (d) {
                    return width_rangeBand(d.x);
                })
                .attr("width", width_rangeBand.rangeBand())
                .attr("height", width_rangeBand.rangeBand())
                .attr(config.link_tip_attribute, config.link_tip_html)
                .style("fill-opacity", function (d) {
                    return opacity_scale(d.z);
                })
                .style("fill", function (d) {
                    return nodes[d.x][find_filter("primary").field] == nodes[d.y][find_filter("primary").field] ? primary_colors(nodes[d.x][find_filter("primary").field]) : null;
                })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout)
                .on("click", function (d) {
                    var modal_content;
                    modal_content = create_similarity_html_title(d, nodes);
                    modal_content = modal_content.replace(/\n/g, '<br />').replace(/  Terms: /g, "&nbsp;&nbsp;&nbsp;Terms: ");
                    $.modal(modal_content);
                });
    }

    function mouseover(p) {
        d3.selectAll(".row text").classed("active", function (d, i) {
            return i == p.y;
        });
        d3.selectAll(".column text").classed("active", function (d, i) {
            return i == p.x;
        });
    }

    function mouseout() {
        d3.selectAll("text").classed("active", false);
    }

    d3.select("#order").on("change", function () {
        selected_order = this.value;
        order(this.value);
    });

    function order(value) {
        width_rangeBand.domain(orders[value]);

        var t = svg.transition().duration(2500);

        t.selectAll(".row")
                .delay(function (d, i) {
                    return width_rangeBand(i) * 4;
                })
                .attr("transform", function (d, i) {
                    return "translate(0," + width_rangeBand(i) + ")";
                })
                .selectAll(".cell")
                .delay(function (d) {
                    return width_rangeBand(d.x) * 4;
                })
                .attr("x", function (d) {
                    return width_rangeBand(d.x);
                });

        t.selectAll(".column")
                .delay(function (d, i) {
                    return width_rangeBand(i) * 4;
                })
                .attr("transform", function (d, i) {
                    return "translate(" + width_rangeBand(i) + ")rotate(-90)";
                });
    }

}

</script>


</body>
</html>
